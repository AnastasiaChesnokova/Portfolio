--Цель проекта DonorSearch — мотивировать людей становиться донорами и делать регулярные донации. 
--Для этого важно понимать, какие факторы влияют на активность доноров и какими могут быть стратегии для их мотивации.
--Основные задачи
--1. Определить регионы с наибольшим количеством зарегистрированных доноров.
--2. Изучить динамику общего количества донаций в месяц за 2022 и 2023 годы.
--3. Определить наиболее активных доноров в системе, учитывая только данные о зарегистрированных и подтвержденных донациях.
--4. Оценить, как система бонусов влияет на зарегистрированные в системе донации.
--5. Исследовать вовлечение новых доноров через социальные сети. Узнать, сколько по каким каналам пришло доноров, и среднее количество донаций по каждому каналу.
--7.Сравнить активность однократных доноров со средней активностью повторных доноров.
--8.Сравнить данные о планируемых донациях с фактическими данными, чтобы оценить эффективность планирования.
--
--1. Определить регионы с наибольшим количеством зарегистрированных доноров.
--Для этого нужно посчитать ко-во доноров и сгруппировать по регионам.
SELECT region, COUNT(DISTINCT id) AS donor_count 
FROM donorsearch.user_anon_data
GROUP BY region 
ORDER BY donor_count DESC 
LIMIT 10;
-- Таблица:
-- region                                     | donor_count
-- -------------------------------------------|-------------
-- Неизвестно                                 | 100574
-- Россия, Москва                             | 37819
-- Россия, Санкт-Петербург                    | 13137
-- Россия, Татарстан, Казань                  | 6610
-- Украина, Киевская область, Киев            | 3541
-- Россия, Новосибирская область, Новосибирск |	3310
-- Россия, Свердловская область, Екатеринбург |3082
-- Россия, Башкортостан, Уфа	3014          |3014
-- Россия, Красноярский край, Красноярск	  |2346
-- Россия, Краснодарский край, Краснодар	  |2186
--
-- На первом месте крупные города. Очень много донаций без места и это стоит исправить
--
-- 2. Изучить динамику общего количества донаций в месяц за 2022 и 2023 годы.
-- Для этого нужно выбрать период с 01.01.22 по 31.12.23  таб donation_anon в условии WHERE с выделением месяца и сосчитать ко-во  донаций
SELECT DATE_TRUNC('month', donation_date) AS month,
       COUNT(id) AS donation_count
FROM donorsearch.donation_anon
WHERE donation_date BETWEEN '2022-01-01' AND '2023-12-31'
GROUP BY month
ORDER BY MONTH DESC;
--month      |donation_count
--2023-11-01    1509
--2023-10-01    2117
--2023-09-01    2240
--2023-08-01 	2433
--2023-07-01 	2276
--2023-06-01 	2651
--2023-05-01 	2568
--2023-04-01 	3523
--2023-03-01 	3523
--2023-02-01 	3056
--2023-01-01 	2795
--2022-12-01 	3303
--2022-11-01 	3156
--2022-10-01 	3265
--2022-09-01	3089
--2022-08-01 	2987
--2022-07-01 	2836
--2022-06-01 	2792
--2022-05-01 	2414
--2022-04-01 	3223
--2022-03-01 	3002
--2022-02-01 	2109
--2022-01-01 	1977
-- В 2022 году наблюдается рост активности доноров в течение года за исключением спадов в мае и июне
-- В 2023 году наблюдается рост активности доноров с декабря по март и спад с апреля по ноябрь
-- В оба года наблюдаются пики активности марте
-- Рекомендации:
-- Увеличить маркетинговые и рекламные кампании в летние месяцы и в предновогодний период (ноябрь-декабрь),
-- чтобы имелся определенный запас на первую половину января, когда имеется спад доноства.
-- Проводить регулярные кампании по привлечению доноров в течение всего года, с особыми акцентами на периоды снижения активности.
-- 3. Определить наиболее активных доноров в системе, учитывая только данные о зарегистрированных и подтвержденных донациям.
-- Для этого нужно вывести йди донора и его подтвержденные донации
SELECT id, confirmed_donations
FROM donorsearch.user_anon_data
ORDER BY confirmed_donations DESC
LIMIT 10;
--id    |confirmed_donations
--235391	361
--273317	257
--201521	236
--211970	236
--132946	227
--53912	    217
--216353	216
--233686	215
--204073	213
--267054	209
-- Самые активные доноры имеют больше 200 донаций крови\плазмы и тромбоцитов.
-- Можно создать программы поощрения активных доноров.
-- Включить истории этих доноров в маркетинговые кампании для мотивации других.
-- Стоит посмотеть на количество сдачи цельной крови, плазмы и тромбоцитов, эритроциты, лейкоцитов по отдельности, 
-- т к цельную кровь можно сдавать не более 5 раз в год, для женщин неболее 4
SELECT id, confirmed_donations, whole_blood_count, plasma_count, platelets_count, red_cells_count, white_cells_count 
FROM donorsearch.user_anon_data
ORDER BY confirmed_donations DESC
LIMIT 10;
-- id|  confirmed_donations| whole_blood_count| plasma_count| platelets_count| red_cells_count| white_cells_count 
--235391	361	             55	                299	              7	              0	              0
--273317	257	             0	                198	              59	          0	              0
--201521	236	             0	                236	              0	              0	              0
--211970	236	             18	                208	              10	          0	              0
--132946	227	             11	                216	              0	              0	              0
--53912	    217	             15	                202	              0	              0 	          0
--216353	216	             19	                160	              37	          0	              0
--233686	215	             31	                163	              21	          0	              0
--204073	213	             42	                115	              56	          0	              0
--267054	209	             38	                171	              0	              0	              0
-- Ухты, донор 235 391 сдавал цельную кровь 55 раз это больше 10 лет донорства!
-- 4. Оценим, как система бонусов влияет на зарегистрированные в системе донации.
--Для этого нужно создать таб donor_activity, которая собирает информацию о донорах и их бонусах.
WITH donor_activity AS -- создаем сте запрос
  (SELECT u.id, -- идентификатор пользователя
          u.confirmed_donations, -- количество подтвержденных донаций
          COALESCE(b.user_bonus_count, 0) AS user_bonus_count  -- нет бонусов, применяется значение 0,  т к  можно создать группы пользователей без бонусов.
   FROM donorsearch.user_anon_data AS u --таб содержит данные о пользователях в системе к ней присоединяем таб кот содержит инфу о бонусах для доноров.
   LEFT JOIN donorsearch.user_anon_bonus AS  b ON u.id = b.user_id) --LEFT JOIN оставяет все данный из таб, указ-ой 1-ой и присоед-т
   -- к ней подходящие значения из 2-й таб
   --Далее собирам статистику по донорской активности
--CASE - логическое выржение если это так то...
--Если у пользователя есть бонусы (user_bonus_count > 0), статус устанавливается как "Получили бонусы". В противном случае — "Не получали бонусы".  
SELECT CASE
           WHEN user_bonus_count > 0 THEN 'Получили бонусы'
           ELSE 'Не получали бонусы'
       END AS статус_бонусов,
       COUNT(id) AS количество_доноров, -- подсчет количества доноров для каждой категории статуса бонусов.
       ROUND(AVG(confirmed_donations),2) AS среднее_количество_донаций -- вычисление среднего количества подтвержденных донатов для каждой категории статуса.
FROM donor_activity -- все берем из сте
GROUP BY статус_бонусов; -- группировка данных по статусу бонусов, чтобы иметь возможность получать агрегированные значения.
-----------------------ко-во доноров/ среднее ко-во донаций
--Не получали бонусы	256491	      0.53
--Получили бонусы	21108	         13.9
-- Доноры, получившие бонусы, в среднем делают значительно больше донаций (~13.90), чем те, кто не получил бонусы (~0.53), 
-- Всего 21108 доноров получили бонусы, что значительно меньше по сравнению с общей базой доноров (256491). 
--Нужно развивать программы лояльности 
-- Рекомендации:
-- Увеличить количество бонусов и наград
-- Проводить более активные маркетинговые кампании
-- Создавать специальные акции и кампании, направленные на доноров, которые ещё не получили бонусы, чтобы мотивировать их к участию.
-- Создавать программы для удержания наиболее активных доноров и поощрять их за продолжение участия в донорских мероприятиях.
--5. Исследуем вовлечение новых доноров через социальные сети
-- - учитывая только тех, кто совершил хотя бы одну донацию. 
-- -Узнаем, сколько по каким каналам пришло доноров, и среднее количество донаций по каждому каналу.
-- Испо-м CASE, для класс-и доноров по социальной сети, из кот они пришли.
--Если донор авторизовался через указанную сеть, то ему присваивается соответствующее название.
--Иначе "Без авторизации через соцсети"
SELECT CASE
	 WHEN autho_vk THEN 'ВКонтакте'
           WHEN autho_ok THEN 'Одноклассники'
           WHEN autho_tg THEN 'Telegram'
           WHEN autho_yandex THEN 'Яндекс'
           WHEN autho_google THEN 'Google'
           ELSE 'Без авторизации через соцсети'
       END AS социальная_сеть, --сохранить колонку как соц.сеть
       COUNT(id) AS количество_доноров,
       ROUND(AVG(confirmed_donations),2) AS среднее_количество_донаций
FROM donorsearch.user_anon_data
GROUP BY социальная_сеть
ORDER BY количество_доноров DESC;
-- социальная_сеть| количество_доноров|среднее_количество_донаций
--ВКонтакте	                 127254	   0.91
--Без авторизации 
--через соцсети	             113266	   0.71
--Google	                  14292	   1.08
--Одноклассники	               6410	   0.56
--Яндекс	                   4133	   1.73
--Telegram	                    481	   1.17
-- Больше всего доноров пришли из ВК или без соцсети, но имеют низкую активность
-- Пришедшие через Яндекс активнее всего, что указывает на высокую вовлечённость
-- Telegram также показывает высокую активность, но количество доноров там минимально
-- Google в золотой середине по количеству пришедших и их вовлеченности
-- Одноклассники имеют наименьшее среднее количество подтверждённых донаций (~0.56)
-- Рекомендации:
-- Увеличить маркетинговые усилия на платформах Яндекс и Telegram, так как они показывают наибольшую активность доноров.
-- Разработать специальные предложения и кампании для доноров, авторизованных через эти сети.
-- Проанализировать причины меньшей активности в Одноклассниках и разработать стратегии для повышения вовлечённости доноров, использующих эту сеть.
-- Может быть Одноклассники это более возрастной контингент, неспособный к высокой активности
-- Стимулировать доноров, не использующих социальные сети, специальными кампаниями и предложениями.
-- Внедрить программы лояльности и награды, ориентированные на доноров из различных социальных сетей, чтобы поддерживать их активность и мотивацию.
--
-- 6. Сравним активность однократных доноров со средней активностью повторных доноров.
-- Группировка по времени: Рассмотреть, как изменяется активность доноров в зависимости от года первой донации.
-- Анализ частоты донаций: Разделить повторных доноров по количеству донаций (например, 2-3, 4-5, 6 и более донаций).
-- Возраст активности доноров: Вычислить, сколько времени прошло с первой донации до текущего момента, чтобы понять, насколько давними являются активные доноры.
WITH donor_activity AS (
  SELECT user_id,
         COUNT(*) AS total_donations,
         (MAX(donation_date) - MIN(donation_date)) AS activity_duration_days,
         (MAX(donation_date) - MIN(donation_date)) / (COUNT(*) - 1) AS avg_days_between_donations,
         EXTRACT(YEAR FROM MIN(donation_date)) AS first_donation_year,
         EXTRACT(YEAR FROM AGE(CURRENT_DATE, MIN(donation_date))) AS years_since_first_donation
  FROM donorsearch.donation_anon
  GROUP BY user_id
  HAVING COUNT(*) > 1
)
SELECT first_donation_year,
       CASE 
           WHEN total_donations BETWEEN 2 AND 3 THEN '2-3 донации'
           WHEN total_donations BETWEEN 4 AND 5 THEN '4-5 донаций'
           ELSE '6 и более донаций'
       END AS donation_frequency_group,
       COUNT(user_id) AS donor_count,
       AVG(total_donations) AS avg_donations_per_donor,
       AVG(activity_duration_days) AS avg_activity_duration_days,
       AVG(avg_days_between_donations) AS avg_days_between_donations,
       AVG(years_since_first_donation) AS avg_years_since_first_donation
FROM donor_activity
GROUP BY first_donation_year, donation_frequency_group
ORDER BY first_donation_year, donation_frequency_group;
-- Выводы:
-- Аномальные данные: В текущем наборе данных были обнаружены серьёзные аномалии, такие как 
-- очень длительные периоды активности доноров (до 1800 лет) и большие промежутки между донациями.
--  Это свидетельствует о наличии ошибок в данных, особенно в части корректности указания дат донаций. 
--  Возможно, такие ошибки связаны с ручным вводом данных или некорректной обработкой при переносе из других источников.
--
-- Активность повторных доноров: Несмотря на аномалии, можно предположить, что повторные доноры демонстрируют 
-- большую вовлечённость и остаются активными в течение длительного времени. Однако без очистки данных 
-- точные цифры для интерпретации этих тенденций недоступны.
--
-- Необходимость фильтрации и чистки данных: Для получения корректных выводов требуется фильтрация по
--  допустимому диапазону дат и пересмотр всех расчетов после очистки данных. Это позволит выявить реальный 
--  уровень активности доноров и сделать более точные выводы о средней частоте донаций и продолжительности участия доноров в программе.
--
-- Повторные доноры — ключевая аудитория: Исходя из структуры данных, повторные доноры играют ключевую роль 
-- в донорских программах, и работа с их поддержанием крайне важна. Они совершают большее количество донаций,
--  что требует внимательного анализа и создания программ удержания.
--
-- Дальнейшие шаги:
-- После очистки данных, ключевой вывод о том, что повторные доноры делают большее количество донаций и остаются активными дольше, можно будет подтвердить с точными показателями.
-- Создание специальных программ, направленных на поддержку и увеличение активности повторных доноров, станет приоритетной задачей.
-- 7. Проанализировать планирования доноров и их реальной активности
WITH planned_donations AS (
  SELECT DISTINCT user_id, donation_date, donation_type
  FROM donorsearch.donation_plan
),
actual_donations AS (
  SELECT DISTINCT user_id, donation_date
  FROM donorsearch.donation_anon
),
planned_vs_actual AS (
  SELECT
    pd.user_id,
    pd.donation_date AS planned_date,
    pd.donation_type,
    CASE WHEN ad.user_id IS NOT NULL THEN 1 ELSE 0 END AS completed
  FROM planned_donations pd
  LEFT JOIN actual_donations ad ON pd.user_id = ad.user_id AND pd.donation_date = ad.donation_date
)
SELECT
  donation_type,
  COUNT(*) AS total_planned_donations,
  SUM(completed) AS completed_donations,
  ROUND(SUM(completed) * 100.0 / COUNT(*), 2) AS completion_rate
FROM planned_vs_actual
GROUP BY donation_type;
-- |donation_type|total_planned_donations|completed_donations|completion_rate|
-- |-------------|-----------------------|-------------------|---------------|
-- |Безвозмездно |          22 903       |        4 950      |      21.61    |
-- |Платно       |          3 299        |        429        |      13.00    |
--
-- Из представленных данных видно, что процент выполнения планов донаций 
-- низок для обоих типов доноров: 21.61% для безвозмездных и 13.00% для платных.
-- Это указывает на необходимость повышения вовлечённости доноров, особенно платных.
-- Рекомендуется провести мероприятия по мотивации доноров, такие как программы поощрения
-- и улучшение коммуникации о важности донорства.
--
--
-- Итоговые рекомендации:
--
-- Региональные кампании: усилить маркетинговые усилия в регионах с низкой активностью доноров, чтобы увеличить их вовлечённость.
-- Программы лояльности: расширить охват программ лояльности и обеспечить, чтобы доноры были осведомлены о возможностях получения бонусов за донации.
-- Вовлечение через социальные сети: активнее использовать платформы Яндекс и Telegram для привлечения доноров, а также разработать стратегии для повышения вовлечённости через Одноклассники.
-- Поддержка повторных доноров: сосредоточиться на удержании и мотивации однократных доноров, чтобы увеличить их активность и сделать их постоянными участниками донорских программ.
